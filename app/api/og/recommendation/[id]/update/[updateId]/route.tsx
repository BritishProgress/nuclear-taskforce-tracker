import { ImageResponse } from '@vercel/og';
import { NextRequest } from 'next/server';
import { getUpdateByDate, getChapters } from '@/lib/data';

export const runtime = 'nodejs';
export const revalidate = 600; // Revalidate at most every 10 minutes

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string; updateId: string }> }
) {
  try {
    const { id, updateId } = await params;
    const updateData = await getUpdateByDate(parseInt(id), updateId);
    
    if (!updateData) {
      return new Response('Update not found', { status: 404 });
    }

    const { recommendation, update } = updateData;
    const chapters = await getChapters();
    const chapter = chapters.find(c => c.id === recommendation.chapter_id);
    
    const statusLabel = update.status === 'completed' ? 'Completed' :
                       update.status === 'progress' ? 'Progress' :
                       update.status === 'risk' ? 'Risk' :
                       update.status === 'off_track' ? 'Off Track' :
                       update.status === 'blocked' ? 'Blocked' :
                       'Info';

    const statusColor = update.status === 'completed' ? '#81F494' :
                       update.status === 'progress' ? '#0B4938' :
                       update.status === 'risk' ? '#F59E0B' :
                       update.status === 'off_track' ? '#B3063E' :
                       update.status === 'blocked' ? '#6B7280' :
                       '#3B82F6';

    const isCompleted = update.status === 'completed';
    
    const imageResponse = new ImageResponse(
      (
        <div
          style={{
            height: '100%',
            width: '100%',
            display: 'flex',
            flexDirection: 'column',
            backgroundColor: '#FDF9E9', // beige background
            fontFamily: 'Inter',
            padding: '80px',
          }}
        >
          {/* Logo and Title */}
          <div
            style={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'flex-start',
              marginBottom: '40px',
            }}
          >
            <svg
              width="500"
              height="60"
              viewBox="0 0 1751 200"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g transform="translate(-156, -100)">
                <path
                  fillRule="evenodd"
                  clipRule="evenodd"
                  d="M242.288 220.715L235.013 213.373L247.444 201.039L257.465 204.518L242.335 220.719L255.389 299.662L270.342 214.454L355.568 199.489L270.332 185.374L269.276 179.36L269.237 179.086L269.229 179.093L255.396 100.314L241.304 185.413L156.22 199.482L235.026 213.311L171.503 276.863L184.408 278.641L242.288 220.715ZM339.169 123.758L286.564 176.404L278.846 169.472L327.306 120.99L339.169 123.758Z"
                  fill="#0B4938"
                />
                <path
                  d="M491.185 249.499C483.214 249.499 476.103 247.639 469.849 243.92C463.596 240.159 458.67 234.785 455.074 227.796C451.518 220.806 449.74 212.427 449.74 202.659C449.74 192.849 451.538 184.45 455.135 177.461C458.732 170.431 463.657 165.056 469.91 161.337C476.205 157.576 483.296 155.696 491.185 155.696C496.089 155.696 500.687 156.412 504.979 157.842C509.312 159.232 513.174 161.296 516.566 164.034C519.959 166.732 522.738 170.043 524.904 173.966C527.112 177.849 528.583 182.263 529.319 187.209H514.053C513.521 184.348 512.581 181.834 511.233 179.668C509.884 177.461 508.188 175.601 506.144 174.089C504.141 172.536 501.893 171.371 499.4 170.594C496.907 169.777 494.23 169.368 491.368 169.368C486.259 169.368 481.702 170.656 477.697 173.231C473.691 175.806 470.544 179.566 468.255 184.511C465.966 189.457 464.822 195.506 464.822 202.659C464.822 209.852 465.966 215.922 468.255 220.868C470.585 225.772 473.732 229.492 477.697 232.026C481.702 234.56 486.259 235.827 491.368 235.827C494.148 235.827 496.784 235.459 499.277 234.723C501.771 233.947 504.019 232.823 506.021 231.351C508.065 229.839 509.761 228 511.11 225.834C512.5 223.667 513.481 221.174 514.053 218.354H529.319C528.665 222.809 527.275 226.937 525.15 230.738C523.065 234.499 520.368 237.789 517.057 240.609C513.746 243.388 509.904 245.575 505.531 247.169C501.157 248.722 496.375 249.499 491.185 249.499Z"
                  fill="#0B4938"
                />
                <path
                  d="M569.353 249.683C562.528 249.683 556.642 248.232 551.696 245.33C546.751 242.428 542.95 238.341 540.293 233.068C537.677 227.755 536.369 221.542 536.369 214.43C536.369 207.4 537.677 201.228 540.293 195.915C542.909 190.561 546.608 186.392 551.39 183.408C556.172 180.383 561.771 178.871 568.188 178.871C572.235 178.871 576.118 179.525 579.837 180.833C583.557 182.141 586.867 184.184 589.769 186.964C592.712 189.743 595.021 193.32 596.697 197.693C598.373 202.025 599.211 207.257 599.211 213.388V218.231H543.849V207.87H591.792L584.926 211.12C584.926 207.073 584.292 203.517 583.025 200.452C581.799 197.386 579.939 194.995 577.446 193.279C574.994 191.521 571.949 190.642 568.311 190.642C564.633 190.642 561.506 191.521 558.931 193.279C556.356 195.036 554.374 197.366 552.984 200.268C551.635 203.129 550.961 206.317 550.961 209.832V216.944C550.961 221.399 551.737 225.18 553.29 228.286C554.844 231.392 557.01 233.763 559.789 235.398C562.568 237.033 565.797 237.85 569.476 237.85C571.887 237.85 574.074 237.503 576.036 236.808C578.039 236.113 579.755 235.071 581.186 233.681C582.657 232.291 583.761 230.575 584.497 228.531L598.352 230.554C597.371 234.396 595.573 237.748 592.957 240.609C590.382 243.47 587.072 245.698 583.025 247.292C579.02 248.886 574.462 249.683 569.353 249.683Z"
                  fill="#0B4938"
                />
                <path
                  d="M622.999 207.87V248.273H608.284V179.729H622.692V191.194H623.489C625.083 187.434 627.535 184.45 630.846 182.243C634.157 179.995 638.387 178.871 643.537 178.871C648.237 178.871 652.345 179.872 655.86 181.875C659.375 183.837 662.093 186.739 664.014 190.581C665.976 194.423 666.957 199.123 666.957 204.682V248.273H652.243V206.767C652.243 201.984 650.996 198.245 648.503 195.547C646.051 192.849 642.658 191.501 638.326 191.501C635.342 191.501 632.706 192.155 630.417 193.463C628.128 194.73 626.309 196.589 624.96 199.042C623.653 201.453 622.999 204.396 622.999 207.87Z"
                  fill="#0B4938"
                />
                <path
                  d="M712.326 179.729V191.378H674.008V179.729H712.326ZM683.817 163.421H698.47V227.918C698.47 230.82 699.103 232.966 700.37 234.356C701.637 235.745 703.62 236.44 706.317 236.44C707.053 236.44 707.83 236.379 708.647 236.256C709.464 236.134 710.262 235.99 711.038 235.827L713.613 247.66C712.101 248.15 710.507 248.518 708.831 248.763C707.155 249.049 705.479 249.192 703.804 249.192C697.632 249.192 692.748 247.517 689.151 244.165C685.595 240.813 683.817 236.297 683.817 230.616V163.421Z"
                  fill="#0B4938"
                />
                <path
                  d="M721.461 248.273V179.729H735.684V190.949H736.42C737.687 187.107 739.874 184.123 742.98 181.998C746.127 179.872 749.663 178.81 753.586 178.81C754.445 178.81 755.426 178.851 756.529 178.932C757.674 178.973 758.614 179.055 759.349 179.178V192.911C758.736 192.747 757.715 192.584 756.284 192.42C754.853 192.216 753.443 192.114 752.054 192.114C749.029 192.114 746.311 192.768 743.9 194.076C741.488 195.384 739.588 197.182 738.198 199.471C736.849 201.719 736.175 204.314 736.175 207.257V248.273H721.461Z"
                  fill="#0B4938"
                />
                <path
                  d="M792.885 249.683C786.06 249.683 780.174 248.232 775.228 245.33C770.283 242.428 766.482 238.341 763.825 233.068C761.209 227.755 759.901 221.542 759.901 214.43C759.901 207.4 761.209 201.228 763.825 195.915C766.441 190.561 770.14 186.392 774.922 183.408C779.704 180.383 785.304 178.871 791.721 178.871C795.767 178.871 799.65 179.525 803.369 180.833C807.089 182.141 810.399 184.184 813.301 186.964C816.244 189.743 818.553 193.32 820.229 197.693C821.905 202.025 822.743 207.257 822.743 213.388V218.231H767.381V207.87H815.324L808.458 211.12C808.458 207.073 807.824 203.517 806.557 200.452C805.331 197.386 803.471 194.995 800.978 193.279C798.526 191.521 795.481 190.642 791.843 190.642C788.165 190.642 785.038 191.521 782.463 193.279C779.888 195.036 777.906 197.366 776.516 200.268C775.167 203.129 774.493 206.317 774.493 209.832V216.944C774.493 221.399 775.269 225.18 776.822 228.286C778.376 231.392 780.542 233.763 783.321 235.398C786.101 237.033 789.329 237.85 793.008 237.85C795.419 237.85 797.606 237.503 799.568 236.808C801.571 236.113 803.287 235.071 804.718 233.681C806.189 232.291 807.293 230.575 808.029 228.531L821.884 230.554C820.904 234.396 819.105 237.748 816.489 240.609C813.914 243.47 810.604 245.698 806.557 247.292C802.552 248.886 797.994 249.683 792.885 249.683Z"
                  fill="#0B4938"
                />
                <path
                  d="M892.758 179.729V191.378H853.213V179.729H892.758ZM863.575 248.273V172.556C863.575 168.101 864.515 164.402 866.395 161.459C868.316 158.517 870.85 156.309 873.997 154.838C877.185 153.367 880.659 152.631 884.42 152.631C887.199 152.631 889.61 152.856 891.654 153.305C893.698 153.755 895.189 154.164 896.13 154.531L892.941 166.18C892.288 165.935 891.47 165.71 890.489 165.506C889.508 165.26 888.323 165.138 886.933 165.138C883.827 165.138 881.599 165.914 880.251 167.468C878.902 168.98 878.227 171.167 878.227 174.028V248.273H863.575Z"
                  fill="#0B4938"
                />
                <path
                  d="M927.826 249.683C921.287 249.683 915.585 248.211 910.721 245.269C905.898 242.285 902.158 238.157 899.501 232.884C896.845 227.571 895.516 221.399 895.516 214.369C895.516 207.257 896.845 201.044 899.501 195.731C902.158 190.377 905.898 186.228 910.721 183.285C915.585 180.342 921.287 178.871 927.826 178.871C934.407 178.871 940.129 180.342 944.993 183.285C949.857 186.228 953.617 190.377 956.273 195.731C958.93 201.044 960.259 207.257 960.259 214.369C960.259 221.399 958.93 227.571 956.273 232.884C953.617 238.157 949.857 242.285 944.993 245.269C940.129 248.211 934.407 249.683 927.826 249.683ZM927.888 237.544C931.852 237.544 935.102 236.501 937.636 234.417C940.211 232.332 942.132 229.533 943.399 226.018C944.707 222.462 945.361 218.558 945.361 214.308C945.361 210.016 944.707 206.113 943.399 202.598C942.132 199.042 940.211 196.221 937.636 194.137C935.102 192.052 931.852 191.01 927.888 191.01C923.964 191.01 920.694 192.052 918.078 194.137C915.503 196.221 913.582 199.042 912.315 202.598C911.048 206.113 910.414 210.016 910.414 214.308C910.414 218.558 911.048 222.462 912.315 226.018C913.582 229.533 915.503 232.332 918.078 234.417C920.694 236.501 923.964 237.544 927.888 237.544Z"
                  fill="#0B4938"
                />
                <path
                  d="M969.516 248.273V179.729H983.74V190.949H984.476C985.743 187.107 987.929 184.123 991.036 181.998C994.183 179.872 997.718 178.81 1001.64 178.81C1002.5 178.81 1003.48 178.851 1004.58 178.932C1005.73 178.973 1006.67 179.055 1007.41 179.178V192.911C1006.79 192.747 1005.77 192.584 1004.34 192.42C1002.91 192.216 1001.5 192.114 1000.11 192.114C997.085 192.114 994.367 192.768 991.955 194.076C989.544 195.384 987.643 197.182 986.254 199.471C984.905 201.719 984.23 204.314 984.23 207.257V248.273H969.516Z"
                  fill="#0B4938"
                />
                <path
                  d="M1041.62 248.273V156.922H1075.89C1082.43 156.922 1087.84 157.965 1092.13 160.049C1096.47 162.134 1099.7 164.995 1101.82 168.632C1103.95 172.229 1105.01 176.276 1105.01 180.772C1105.01 184.532 1104.29 187.72 1102.86 190.336C1101.47 192.952 1099.59 195.057 1097.22 196.651C1094.89 198.245 1092.28 199.41 1089.38 200.145V201.065C1092.52 201.187 1095.55 202.168 1098.45 204.008C1101.39 205.806 1103.8 208.34 1105.68 211.61C1107.6 214.88 1108.56 218.844 1108.56 223.504C1108.56 228.204 1107.44 232.435 1105.19 236.195C1102.99 239.914 1099.59 242.857 1095.02 245.023C1090.48 247.19 1084.67 248.273 1077.6 248.273H1041.62ZM1056.76 235.459H1075.64C1081.94 235.459 1086.45 234.233 1089.19 231.781C1091.97 229.328 1093.36 226.263 1093.36 222.584C1093.36 219.723 1092.67 217.169 1091.28 214.921C1089.89 212.632 1087.9 210.813 1085.33 209.464C1082.75 208.115 1079.71 207.441 1076.19 207.441H1056.76V235.459ZM1056.76 196.16H1074.23C1077.22 196.16 1079.89 195.588 1082.26 194.443C1084.63 193.299 1086.51 191.705 1087.9 189.661C1089.29 187.618 1089.99 185.186 1089.99 182.366C1089.99 178.728 1088.7 175.703 1086.13 173.292C1083.59 170.84 1079.75 169.613 1074.6 169.613H1056.76V196.16Z"
                  fill="#0B4938"
                />
                <path
                  d="M1118.13 248.273V179.729H1132.35V190.949H1133.09C1134.36 187.107 1136.54 184.123 1139.65 181.998C1142.8 179.872 1146.33 178.81 1150.25 178.81C1151.11 178.81 1152.09 178.851 1153.2 178.932C1154.34 178.973 1155.28 179.055 1156.02 179.178V192.911C1155.4 192.747 1154.38 192.584 1152.95 192.42C1151.52 192.216 1150.11 192.114 1148.72 192.114C1145.7 192.114 1142.98 192.768 1140.57 194.076C1138.16 195.384 1136.26 197.182 1134.87 199.471C1133.52 201.719 1132.84 204.314 1132.84 207.257V248.273H1118.13Z"
                  fill="#0B4938"
                />
                <path
                  d="M1162.15 248.273V179.729H1176.86V248.273H1162.15ZM1169.51 169.675C1167.09 169.675 1165.01 168.857 1163.25 167.222C1161.49 165.587 1160.62 163.605 1160.62 161.275C1160.62 158.946 1161.49 156.984 1163.25 155.39C1165.01 153.755 1167.09 152.937 1169.51 152.937C1171.96 152.937 1174.04 153.755 1175.76 155.39C1177.52 156.984 1178.4 158.946 1178.4 161.275C1178.4 163.605 1177.52 165.587 1175.76 167.222C1174.04 168.857 1171.96 169.675 1169.51 169.675Z"
                  fill="#0B4938"
                />
                <path
                  d="M1222.17 179.729V191.378H1183.85V179.729H1222.17ZM1193.66 163.421H1208.31V227.918C1208.31 230.82 1208.95 232.966 1210.21 234.356C1211.48 235.745 1213.46 236.44 1216.16 236.44C1216.9 236.44 1217.67 236.379 1218.49 236.256C1219.31 236.134 1220.11 235.99 1220.88 235.827L1223.46 247.66C1221.95 248.15 1220.35 248.518 1218.68 248.763C1217 249.049 1215.32 249.192 1213.65 249.192C1207.48 249.192 1202.59 247.517 1199 244.165C1195.44 240.813 1193.66 236.297 1193.66 230.616V163.421Z"
                  fill="#0B4938"
                />
                <path
                  d="M1231.3 248.273V179.729H1246.02V248.273H1231.3ZM1238.66 169.675C1236.25 169.675 1234.17 168.857 1232.41 167.222C1230.65 165.587 1229.77 163.605 1229.77 161.275C1229.77 158.946 1230.65 156.984 1232.41 155.39C1234.17 153.755 1236.25 152.937 1238.66 152.937C1241.11 152.937 1243.2 153.755 1244.92 155.39C1246.67 156.984 1247.55 158.946 1247.55 161.275C1247.55 163.605 1246.67 165.587 1244.92 167.222C1243.2 168.857 1241.11 169.675 1238.66 169.675Z"
                  fill="#0B4938"
                />
                <path
                  d="M1310.95 197.264L1297.58 199.042C1296.93 196.794 1295.56 194.75 1293.47 192.911C1291.39 191.072 1288.36 190.152 1284.4 190.152C1280.84 190.152 1277.86 190.949 1275.45 192.543C1273.08 194.137 1271.89 196.16 1271.89 198.612C1271.89 200.738 1272.69 202.475 1274.28 203.824C1275.88 205.173 1278.49 206.276 1282.13 207.134L1293.41 209.587C1299.79 210.976 1304.53 213.204 1307.63 216.269C1310.78 219.294 1312.36 223.238 1312.36 228.102C1312.36 232.312 1311.13 236.052 1308.68 239.322C1306.27 242.551 1302.91 245.085 1298.62 246.924C1294.33 248.763 1289.38 249.683 1283.79 249.683C1275.73 249.683 1269.21 247.966 1264.23 244.533C1259.28 241.1 1256.28 236.297 1255.22 230.125L1269.5 228.409C1270.28 231.638 1271.87 234.069 1274.28 235.704C1276.73 237.339 1279.88 238.157 1283.72 238.157C1287.81 238.157 1291.1 237.319 1293.59 235.643C1296.09 233.926 1297.33 231.842 1297.33 229.39C1297.33 225.302 1294.17 222.543 1287.83 221.113L1276.24 218.538C1269.75 217.107 1264.94 214.798 1261.84 211.61C1258.73 208.422 1257.18 204.376 1257.18 199.471C1257.18 195.302 1258.32 191.685 1260.61 188.619C1262.9 185.554 1266.09 183.163 1270.17 181.446C1274.26 179.729 1278.96 178.871 1284.28 178.871C1292 178.871 1298.07 180.547 1302.48 183.898C1306.9 187.209 1309.72 191.664 1310.95 197.264Z"
                  fill="#0B4938"
                />
                <path
                  d="M1336.14 207.87V248.273H1321.43V156.922H1335.84V191.194H1336.76C1338.35 187.393 1340.8 184.389 1344.11 182.182C1347.42 179.975 1351.74 178.871 1357.05 178.871C1361.75 178.871 1365.86 179.852 1369.37 181.814C1372.93 183.776 1375.69 186.678 1377.65 190.52C1379.61 194.362 1380.59 199.083 1380.59 204.682V248.273H1365.82V206.767C1365.82 201.903 1364.57 198.142 1362.08 195.486C1359.62 192.829 1356.17 191.501 1351.72 191.501C1348.69 191.501 1346.01 192.155 1343.68 193.463C1341.35 194.73 1339.52 196.589 1338.17 199.042C1336.82 201.453 1336.14 204.396 1336.14 207.87Z"
                  fill="#0B4938"
                />
                <path
                  d="M1420.99 248.273V156.922H1454.41C1461.48 156.922 1467.36 158.23 1472.06 160.846C1476.81 163.462 1480.36 167.038 1482.73 171.575C1485.14 176.071 1486.35 181.18 1486.35 186.903C1486.35 192.625 1485.14 197.754 1482.73 202.291C1480.32 206.787 1476.72 210.343 1471.94 212.959C1467.2 215.534 1461.32 216.821 1454.29 216.821H1431.72V204.13H1452.51C1456.8 204.13 1460.29 203.395 1462.99 201.923C1465.73 200.452 1467.73 198.408 1469 195.792C1470.31 193.176 1470.96 190.213 1470.96 186.903C1470.96 183.51 1470.31 180.526 1469 177.951C1467.73 175.376 1465.73 173.374 1462.99 171.943C1460.29 170.472 1456.76 169.736 1452.38 169.736H1436.14V248.273H1420.99Z"
                  fill="#0B4938"
                />
                <path
                  d="M1495.67 248.273V179.729H1509.89V190.949H1510.63C1511.9 187.107 1514.08 184.123 1517.19 181.998C1520.34 179.872 1523.87 178.81 1527.79 178.81C1528.65 178.81 1529.63 178.851 1530.74 178.932C1531.88 178.973 1532.82 179.055 1533.56 179.178V192.911C1532.94 192.747 1531.92 192.584 1530.49 192.42C1529.06 192.216 1527.65 192.114 1526.26 192.114C1523.24 192.114 1520.52 192.768 1518.11 194.076C1515.7 195.384 1513.8 197.182 1512.41 199.471C1511.06 201.719 1510.38 204.314 1510.38 207.257V248.273H1495.67Z"
                  fill="#0B4938"
                />
                <path
                  d="M1566.42 249.683C1559.88 249.683 1554.18 248.211 1549.31 245.269C1544.49 242.285 1540.75 238.157 1538.09 232.884C1535.44 227.571 1534.11 221.399 1534.11 214.369C1534.11 207.257 1535.44 201.044 1538.09 195.731C1540.75 190.377 1544.49 186.228 1549.31 183.285C1554.18 180.342 1559.88 178.871 1566.42 178.871C1573 178.871 1578.72 180.342 1583.59 183.285C1588.45 186.228 1592.21 190.377 1594.87 195.731C1597.52 201.044 1598.85 207.257 1598.85 214.369C1598.85 221.399 1597.52 227.571 1594.87 232.884C1592.21 238.157 1588.45 242.285 1583.59 245.269C1578.72 248.211 1573 249.683 1566.42 249.683ZM1566.48 237.544C1570.45 237.544 1573.69 236.501 1576.23 234.417C1578.8 232.332 1580.72 229.533 1581.99 226.018C1583.3 222.462 1583.95 218.558 1583.95 214.308C1583.95 210.016 1583.3 206.113 1581.99 202.598C1580.72 199.042 1578.8 196.221 1576.23 194.137C1573.69 192.052 1570.45 191.01 1566.48 191.01C1562.56 191.01 1559.29 192.052 1556.67 194.137C1554.1 196.221 1552.18 199.042 1550.91 202.598C1549.64 206.113 1549.01 210.016 1549.01 214.308C1549.01 218.558 1549.64 222.462 1550.91 226.018C1552.18 229.533 1554.1 232.332 1556.67 234.417C1559.29 236.501 1562.56 237.544 1566.48 237.544Z"
                  fill="#0B4938"
                />
                <path
                  d="M1637.29 275.371C1628.83 275.371 1622.17 273.757 1617.31 270.528C1612.48 267.299 1609.27 263.436 1607.68 258.94L1620.62 254.833C1621.35 256.141 1622.37 257.489 1623.68 258.879C1624.99 260.31 1626.75 261.495 1628.95 262.435C1631.2 263.416 1634.04 263.906 1637.48 263.906C1642.3 263.906 1646.28 262.742 1649.43 260.412C1652.62 258.082 1654.21 254.301 1654.21 249.07V235.888H1653.29C1652.52 237.441 1651.35 239.097 1649.8 240.854C1648.25 242.612 1646.16 244.124 1643.55 245.391C1640.93 246.617 1637.58 247.23 1633.49 247.23C1628.18 247.23 1623.38 245.984 1619.08 243.491C1614.79 240.956 1611.38 237.217 1608.84 232.271C1606.35 227.325 1605.11 221.174 1605.11 213.817C1605.11 206.378 1606.35 200.063 1608.84 194.873C1611.34 189.682 1614.75 185.717 1619.08 182.979C1623.42 180.24 1628.28 178.871 1633.68 178.871C1637.8 178.871 1641.18 179.566 1643.79 180.956C1646.41 182.304 1648.47 183.939 1649.98 185.86C1651.5 187.74 1652.66 189.437 1653.48 190.949H1654.4V179.729H1668.74V249.621C1668.74 255.466 1667.37 260.289 1664.64 264.09C1661.9 267.892 1658.16 270.712 1653.42 272.551C1648.68 274.431 1643.3 275.371 1637.29 275.371ZM1637.29 235.398C1642.73 235.398 1646.92 233.477 1649.86 229.635C1652.8 225.752 1654.27 220.418 1654.27 213.633C1654.27 209.137 1653.62 205.213 1652.31 201.862C1651.05 198.51 1649.15 195.894 1646.61 194.014C1644.08 192.093 1640.97 191.133 1637.29 191.133C1633.49 191.133 1630.3 192.134 1627.73 194.137C1625.19 196.099 1623.27 198.776 1621.97 202.168C1620.7 205.561 1620.06 209.382 1620.06 213.633C1620.06 217.966 1620.72 221.767 1622.03 225.037C1623.33 228.306 1625.26 230.861 1627.79 232.7C1630.36 234.499 1633.53 235.398 1637.29 235.398Z"
                  fill="#0B4938"
                />
                <path
                  d="M1681.07 248.273V179.729H1695.29V190.949H1696.03C1697.29 187.107 1699.48 184.123 1702.59 181.998C1705.73 179.872 1709.27 178.81 1713.19 178.81C1714.05 178.81 1715.03 178.851 1716.14 178.932C1717.28 178.973 1718.22 179.055 1718.96 179.178V192.911C1718.34 192.747 1717.32 192.584 1715.89 192.42C1714.46 192.216 1713.05 192.114 1711.66 192.114C1708.64 192.114 1705.92 192.768 1703.51 194.076C1701.09 195.384 1699.19 197.182 1697.8 199.471C1696.46 201.719 1695.78 204.314 1695.78 207.257V248.273H1681.07Z"
                  fill="#0B4938"
                />
                <path
                  d="M1752.49 249.683C1745.67 249.683 1739.78 248.232 1734.83 245.33C1729.89 242.428 1726.09 238.341 1723.43 233.068C1720.82 227.755 1719.51 221.542 1719.51 214.43C1719.51 207.4 1720.82 201.228 1723.43 195.915C1726.05 190.561 1729.75 186.392 1734.53 183.408C1739.31 180.383 1744.91 178.871 1751.33 178.871C1755.37 178.871 1759.26 179.525 1762.98 180.833C1766.69 182.141 1770.01 184.184 1772.91 186.964C1775.85 189.743 1778.16 193.32 1779.84 197.693C1781.51 202.025 1782.35 207.257 1782.35 213.388V218.231H1726.99V207.87H1774.93L1768.06 211.12C1768.06 207.073 1767.43 203.517 1766.16 200.452C1764.94 197.386 1763.08 194.995 1760.58 193.279C1758.13 191.521 1755.09 190.642 1751.45 190.642C1747.77 190.642 1744.64 191.521 1742.07 193.279C1739.49 195.036 1737.51 197.366 1736.12 200.268C1734.77 203.129 1734.1 206.317 1734.1 209.832V216.944C1734.1 221.399 1734.88 225.18 1736.43 228.286C1737.98 231.392 1740.15 233.763 1742.93 235.398C1745.71 237.033 1748.94 237.85 1752.61 237.85C1755.03 237.85 1757.21 237.503 1759.17 236.808C1761.18 236.113 1762.89 235.071 1764.32 233.681C1765.8 232.291 1766.9 230.575 1767.63 228.531L1781.49 230.554C1780.51 234.396 1778.71 237.748 1776.1 240.609C1773.52 243.47 1770.21 245.698 1766.16 247.292C1762.16 248.886 1757.6 249.683 1752.49 249.683Z"
                  fill="#0B4938"
                />
                <path
                  d="M1844.09 197.264L1830.72 199.042C1830.07 196.794 1828.7 194.75 1826.61 192.911C1824.53 191.072 1821.5 190.152 1817.54 190.152C1813.98 190.152 1811 190.949 1808.59 192.543C1806.22 194.137 1805.03 196.16 1805.03 198.612C1805.03 200.738 1805.83 202.475 1807.42 203.824C1809.02 205.173 1811.63 206.276 1815.27 207.134L1826.55 209.587C1832.93 210.976 1837.67 213.204 1840.78 216.269C1843.92 219.294 1845.5 223.238 1845.5 228.102C1845.5 232.312 1844.27 236.052 1841.82 239.322C1839.41 242.551 1836.06 245.085 1831.76 246.924C1827.47 248.763 1822.53 249.683 1816.93 249.683C1808.88 249.683 1802.36 247.966 1797.37 244.533C1792.42 241.1 1789.42 236.297 1788.36 230.125L1802.64 228.409C1803.42 231.638 1805.01 234.069 1807.42 235.704C1809.88 237.339 1813.02 238.157 1816.87 238.157C1820.95 238.157 1824.24 237.319 1826.74 235.643C1829.23 233.926 1830.48 231.842 1830.48 229.39C1830.48 225.302 1827.31 222.543 1820.97 221.113L1809.39 218.538C1802.89 217.107 1798.08 214.798 1794.98 211.61C1791.87 208.422 1790.32 204.376 1790.32 199.471C1790.32 195.302 1791.46 191.685 1793.75 188.619C1796.04 185.554 1799.23 183.163 1803.32 181.446C1807.4 179.729 1812.1 178.871 1817.42 178.871C1825.14 178.871 1831.21 180.547 1835.63 183.898C1840.04 187.209 1842.86 191.664 1844.09 197.264Z"
                  fill="#0B4938"
                />
                <path
                  d="M1907.24 197.264L1893.87 199.042C1893.22 196.794 1891.85 194.75 1889.76 192.911C1887.68 191.072 1884.65 190.152 1880.69 190.152C1877.13 190.152 1874.15 190.949 1871.74 192.543C1869.37 194.137 1868.18 196.16 1868.18 198.612C1868.18 200.738 1868.98 202.475 1870.57 203.824C1872.17 205.173 1874.78 206.276 1878.42 207.134L1889.7 209.587C1896.08 210.976 1900.82 213.204 1903.92 216.269C1907.07 219.294 1908.65 223.238 1908.65 228.102C1908.65 232.312 1907.42 236.052 1904.97 239.322C1902.56 242.551 1899.2 245.085 1894.91 246.924C1890.62 248.763 1885.67 249.683 1880.08 249.683C1872.02 249.683 1865.5 247.966 1860.52 244.533C1855.57 241.1 1852.57 236.297 1851.51 230.125L1865.79 228.409C1866.57 231.638 1868.16 234.069 1870.57 235.704C1873.02 237.339 1876.17 238.157 1880.01 238.157C1884.1 238.157 1887.39 237.319 1889.88 235.643C1892.38 233.926 1893.62 231.842 1893.62 229.39C1893.62 225.302 1890.46 222.543 1884.12 221.113L1872.53 218.538C1866.04 217.107 1861.23 214.798 1858.13 211.61C1855.02 208.422 1853.47 204.376 1853.47 199.471C1853.47 195.302 1854.61 191.685 1856.9 188.619C1859.19 185.554 1862.38 183.163 1866.46 181.446C1870.55 179.729 1875.25 178.871 1880.57 178.871C1888.29 178.871 1894.36 180.547 1898.77 183.898C1903.19 187.209 1906.01 191.664 1907.24 197.264Z"
                  fill="#0B4938"
                />
              </g>
            </svg>
            <div
              style={{
                display: 'flex',
                fontSize: '36px',
                fontWeight: '600',
                color: '#0B4938',
                marginTop: '12px',
              }}
            >
              Nuclear Taskforce Tracker
            </div>
          </div>

          {/* Update Badge */}
          <div
            style={{
              display: 'flex',
              marginBottom: isCompleted ? '60px' : '40px',
            }}
          >
            <div
              style={{
                display: 'flex',
                padding: '16px 32px',
                backgroundColor: '#0B4938',
                borderRadius: '12px',
                fontSize: '40px',
                fontWeight: 'bold',
                color: '#FFFFFF',
              }}
            >
              UPDATE
            </div>
          </div>

          {/* Completed Status - Big and Clear */}
          {isCompleted && (
            <div
              style={{
                display: 'flex',
                marginBottom: '50px',
                width: '100%',
              }}
            >
              <div
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '40px 60px',
                  backgroundColor: '#81F494',
                  borderRadius: '20px',
                  width: '100%',
                }}
              >
                <div
                  style={{
                    display: 'flex',
                    fontSize: '100px',
                    fontWeight: 'bold',
                    color: '#0B4938',
                    textAlign: 'center',
                    alignItems: 'center',
                    justifyContent: 'center',
                    letterSpacing: '4px',
                  }}
                >
                  COMPLETED
                </div>
              </div>
            </div>
          )}

          {/* Update Title */}
          <div
            style={{
              display: 'flex',
              fontSize: isCompleted ? '72px' : '88px',
              fontWeight: 'bold',
              color: '#0B4938',
              marginBottom: '30px',
              lineHeight: '1.2',
              maxWidth: '100%',
            }}
          >
            {update.title}
          </div>

          {/* Date and Status (only show status if not completed, since completed is shown above) */}
          <div
            style={{
              display: 'flex',
              flexDirection: 'row',
              alignItems: 'center',
              gap: '20px',
              marginBottom: '50px',
            }}
          >
            <div
              style={{
                display: 'flex',
                fontSize: '36px',
                color: '#6B7280',
                fontFamily: 'ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace',
              }}
            >
              {new Date(update.date).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: '2-digit',
              })}
            </div>
            {!isCompleted && (
              <div
                style={{
                  display: 'flex',
                  padding: '12px 24px',
                  backgroundColor: statusColor,
                  borderRadius: '12px',
                  fontSize: '32px',
                  fontWeight: 'bold',
                  color: '#FFFFFF',
                }}
              >
                {statusLabel}
              </div>
            )}
          </div>

          {/* Recommendation Context */}
          <div
            style={{
              display: 'flex',
              flexDirection: 'column',
              gap: '12px',
              padding: '30px',
              backgroundColor: 'rgba(11, 73, 56, 0.05)',
              borderRadius: '16px',
              marginBottom: '60px',
            }}
          >
            <div
              style={{
                display: 'flex',
                fontSize: '32px',
                color: '#6B7280',
                fontWeight: '600',
                marginBottom: '8px',
              }}
            >
              Recommendation
            </div>
            <div
              style={{
                display: 'flex',
                fontSize: '56px',
                fontWeight: 'bold',
                color: '#0B4938',
                fontFamily: 'ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace',
                marginBottom: '8px',
              }}
            >
              {recommendation.code}
            </div>
            <div
              style={{
                display: 'flex',
                fontSize: '36px',
                color: '#6B7280',
              }}
            >
              {recommendation.titles.short}
            </div>
          </div>

          {/* Footer */}
          <div
            style={{
              display: 'flex',
              marginTop: 'auto',
              fontSize: '36px',
              color: '#6B7280',
            }}
          >
            Nuclear Taskforce Tracker
          </div>
        </div>
      ),
      {
        width: 2400,
        height: 1260,
      }
    );

    const headers = new Headers(imageResponse.headers);
    headers.set('Cache-Control', 'public, max-age=600, s-maxage=600, stale-while-revalidate=86400');
    
    return new Response(imageResponse.body, {
      status: imageResponse.status,
      statusText: imageResponse.statusText,
      headers: headers,
    });
  } catch (error: unknown) {
    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
    console.error('OG image generation failed:', errorMessage);
    
    return new Response(
      JSON.stringify({ 
        error: 'Failed to generate the image',
        message: process.env.NODE_ENV === 'development' ? errorMessage : undefined,
      }),
      {
        status: 500,
        headers: {
          'Content-Type': 'application/json',
        },
      }
    );
  }
}

